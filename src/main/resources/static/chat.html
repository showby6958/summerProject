<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>1:1 채팅</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; background-color: #f0f2f5; }
        .chat-container { width: 450px; border: 1px solid #ccc; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); background-color: #fff; display: flex; flex-direction: column; }
        .chat-header { background-color: #007bff; color: white; padding: 15px; text-align: center; font-size: 1.2em; border-top-left-radius: 8px; border-top-right-radius: 8px;}
        #loginInfo { padding: 10px 15px; background-color: #f8f9fa; font-size: 0.9em; border-bottom: 1px solid #ddd; }
        #loginInfo span { font-weight: bold; }
        #chatBox { height: 450px; overflow-y: auto; padding: 15px; border-bottom: 1px solid #ddd; }
        #chatMessages { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; }
        .message { margin-bottom: 12px; line-height: 1.4; max-width: 80%; }
        .my-message { align-self: flex-end; text-align: right; }
        .other-message { align-self: flex-start; text-align: left; }
        .message-bubble { display: inline-block; padding: 10px 15px; border-radius: 20px; }
        .my-message .message-bubble { background-color: #dcf8c6; }
        .other-message .message-bubble { background-color: #e9e9eb; }
        .message-sender { font-size: 0.8em; color: #555; margin-bottom: 5px; font-weight: bold; }
        .message-content { font-size: 1em; }
        .message-time { font-size: 0.7em; color: #999; margin-top: 3px; }
        .input-container { display: flex; padding: 15px; background-color: #f8f9fa; border-bottom-left-radius: 8px; border-bottom-right-radius: 8px;}
        #receiverInput, #messageInput { border: 1px solid #ccc; padding: 10px; border-radius: 20px; outline: none; }
        #receiverInput { width: 140px; margin-right: 8px; }
        #messageInput { flex-grow: 1; margin-right: 8px; }
        #sendButton { background-color: #007bff; color: white; border: none; padding: 10px 18px; border-radius: 20px; cursor: pointer; font-weight: bold; }
        #sendButton:hover { background-color: #0056b3; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>

<div class="chat-container">
    <div class="chat-header">1:1 채팅</div>
    <div id="loginInfo">로그인 계정: <span id="currentUser"></span></div>
    <div id="chatBox">
        <ul id="chatMessages"></ul>
    </div>
    <div class="input-container">
        <input type="text" id="receiverInput" placeholder="상대방 이메일" />
        <input type="text" id="messageInput" placeholder="메시지를 입력하세요..." onkeydown="if(event.keyCode==13) sendMessage()" />
        <button id="sendButton" onclick="sendMessage()">전송</button>
    </div>
</div>

<script>
    let stompClient = null;
    let currentUserEmail = null;

    // 페이지 로드 시 JWT 토큰을 로컬 스토리지에서 가져옴 (로그인 시 저장했다고 가정)
    const jwtToken = localStorage.getItem('jwt_token');

    if (!jwtToken) {
        alert("로그인이 필요합니다. 로그인 페이지로 이동합니다.");
        // 실제 서비스에서는 로그인 페이지로 리디렉션
        // window.location.href = '/login.html'; 
    } else {
        // JWT 페이로드 디코딩으로 사용자 이메일(sub) 추출
        try {
            currentUserEmail = JSON.parse(atob(jwtToken.split('.')[1])).sub;
            document.getElementById('currentUser').textContent = currentUserEmail;
            connect();
        } catch (e) {
            console.error("Invalid JWT Token", e);
            alert("유효하지 않은 토큰입니다. 다시 로그인해주세요.");
        }
    }

    function connect() {
        const socket = new SockJS('/ws-chat');
        stompClient = Stomp.over(socket);

        const headers = {
            Authorization: `Bearer ${jwtToken}`
        };

        stompClient.connect(headers, function (frame) {
            console.log('WebSocket 서버에 연결되었습니다: ' + frame);

            // 개인 메시지를 수신할 경로를 구독
            stompClient.subscribe(`/user/${currentUserEmail}/queue/messages`, function (message) {
                const msg = JSON.parse(message.body);
                showMessage(msg);
            });
        }, function(error) {
            console.error('WebSocket 연결 실패: ', error);
            alert('서버 연결에 실패했습니다. 로그인 상태를 확인하고 페이지를 새로고침 해주세요.');
        });
    }

    function sendMessage() {
        const receiver = document.getElementById("receiverInput").value.trim();
        const content = document.getElementById("messageInput").value.trim();

        if (content === "" || receiver === "") {
            alert("받는 사람과 메시지를 모두 입력해주세요.");
            return;
        }
        
        if (receiver === currentUserEmail) {
            alert("자기 자신에게는 메시지를 보낼 수 없습니다.");
            return;
        }

        const chatMessage = {
            receiver: receiver,
            content: content
            // sender와 timestamp는 서버에서 자동으로 설정
        };

        // 서버의 /app/chat/message 목적지로 메시지 전송
        stompClient.send("/app/chat/message", {}, JSON.stringify(chatMessage));
        
        // 내가 보낸 메시지를 내 화면에도 표시
        const sentMessage = { 
            ...chatMessage, 
            sender: currentUserEmail, 
            timestamp: new Date().toISOString() 
        };
        showMessage(sentMessage);
        
        document.getElementById("messageInput").value = '';
        document.getElementById("messageInput").focus();
    }

    function showMessage(message) {
        const chatMessages = document.getElementById("chatMessages");
        const li = document.createElement("li");
        li.className = 'message';

        const bubble = document.createElement('div');
        bubble.className = 'message-bubble';

        const senderDiv = document.createElement('div');
        senderDiv.className = 'message-sender';
        senderDiv.textContent = message.sender;

        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        contentDiv.textContent = message.content;

        const time = new Date(message.timestamp);
        const timeString = time.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', hour12: false });
        const timeDiv = document.createElement('div');
        timeDiv.className = 'message-time';
        timeDiv.textContent = timeString;

        bubble.appendChild(senderDiv);
        bubble.appendChild(contentDiv);
        bubble.appendChild(timeDiv);
        li.appendChild(bubble);

        if (message.sender === currentUserEmail) {
            li.classList.add('my-message');
        } else {
            li.classList.add('other-message');
        }

        chatMessages.appendChild(li);

        // 스크롤을 항상 아래로 이동
        const chatBox = document.getElementById("chatBox");
        chatBox.scrollTop = chatBox.scrollHeight;
    }
</script>
</body>
</html>
