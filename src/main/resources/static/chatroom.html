<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chat Room</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; }
        #chat-container { display: none; }
        #messages {
            height: 400px;
            border: 1px solid #ddd;
            padding: 10px;
            overflow-y: scroll;
            margin-bottom: 10px;
        }
        .message {
            list-style-type: none;
            margin-bottom: 5px;
            padding: 5px 10px;
            border-radius: 5px;
        }
        .my-message {
            background-color: #dcf8c6;
            text-align: right;
            margin-left: auto;
            max-width: 70%;
        }
        .other-message {
            background-color: #f1f0f0;
            text-align: left;
            margin-right: auto;
            max-width: 70%;
        }
    </style>
</head>
<body>

<div class="container">
    <h2>Chat Room Test Page</h2>

    <!-- JWT Token Input -->
    <div class="mb-3">
        <label for="token" class="form-label">JWT Token</label>
        <input type="text" class="form-control" id="token" placeholder="Enter your JWT token here">
        <div class="form-text">Login first to get a token.</div>
    </div>

    <!-- Room Management -->
    <div id="room-management">
        <h4>1. Create or Join a Room</h4>
        <div class="input-group mb-3">
            <input type="text" class="form-control" id="room-name" placeholder="Enter new room name">
            <button class="btn btn-primary" onclick="createRoom()">Create Room</button>
        </div>
        <div class="mb-3">
            <h5>Available Rooms</h5>
            <ul id="room-list" class="list-group"></ul>
            <button class="btn btn-secondary mt-2" onclick="getRooms()">Refresh List</button>
        </div>
    </div>

    <!-- Chat Container -->
    <div id="chat-container">
        <h3 id="room-title"></h3>
        <div id="messages"></div>
        <div class="input-group">
            <input type="text" class="form-control" id="message" placeholder="Type a message...">
            <button class="btn btn-success" onclick="sendMessage()">Send</button>
            <button class="btn btn-danger" onclick="disconnect()">Leave Room</button>
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script>
    let stompClient = null;
    let roomId = null;
    let username = null; // You might want to decode this from JWT

    // DOM Elements
    const roomManagementDiv = document.getElementById('room-management');
    const chatContainerDiv = document.getElementById('chat-container');
    const messagesDiv = document.getElementById('messages');
    const roomListUl = document.getElementById('room-list');
    const roomTitleH3 = document.getElementById('room-title');
    const tokenInput = document.getElementById('token');
    const messageInput = document.getElementById('message');

    function getAuthHeaders() {
        const token = tokenInput.value;
        if (!token) {
            alert('Please enter a JWT token.');
            throw new Error("JWT Token is missing.");
        }
        // Simple decoding to get username (for display purposes)
        try {
            username = JSON.parse(atob(token.split('.')[1])).sub;
        } catch (e) {
            console.error("Could not decode token to get username", e);
            username = "UnknownUser";
        }
        return { 'Authorization': `Bearer ${token}` };
    }

    async function getRooms() {
        try {
            const headers = getAuthHeaders();
            const response = await fetch('/api/chat/rooms', { headers });
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const rooms = await response.json();
            
            roomListUl.innerHTML = '';
            rooms.forEach(room => {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                li.textContent = `Room: ${room.name} (ID: ${room.roomId})`;
                
                const joinButton = document.createElement('button');
                joinButton.className = 'btn btn-sm btn-info';
                joinButton.textContent = 'Join';
                joinButton.onclick = () => joinRoom(room.roomId, room.name);
                
                li.appendChild(joinButton);
                roomListUl.appendChild(li);
            });
        } catch (error) {
            console.error('Error fetching rooms:', error);
        }
    }

    async function createRoom() {
        try {
            const headers = getAuthHeaders();
            const roomName = document.getElementById('room-name').value;
            if (!roomName) {
                alert('Please enter a room name.');
                return;
            }
            const response = await fetch('/api/chat/rooms', {
                method: 'POST',
                headers: { ...headers, 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: roomName })
            });
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            await response.json();
            getRooms(); // Refresh the list
            document.getElementById('room-name').value = '';
        } catch (error) {
            console.error('Error creating room:', error);
        }
    }

    function joinRoom(id, name) {
        if (stompClient) {
            disconnect();
        }
        roomId = id;
        roomTitleH3.textContent = `Chatting in: ${name} (ID: ${roomId})`;
        roomManagementDiv.style.display = 'none';
        chatContainerDiv.style.display = 'block';
        messagesDiv.innerHTML = '';
        connect();
    }

    function connect() {
        try {
            const headers = getAuthHeaders();
            const socket = new SockJS('/ws-chat');
            stompClient = Stomp.over(socket);

            stompClient.connect(headers, frame => {
                console.log('Connected: ' + frame);
                
                // 1. Fetch chat history
                fetchHistory();

                // 2. Subscribe to the room topic
                stompClient.subscribe(`/topic/chat/rooms/${roomId}`, message => {
                    const chatMessage = JSON.parse(message.body);
                    showMessage(chatMessage);
                });

            }, error => {
                console.error('Connection error: ' + error);
                alert('Connection failed. Check console for details.');
            });
        } catch (error) {
            console.error('Connection setup failed:', error);
        }
    }
    
    async function fetchHistory() {
        try {
            const headers = getAuthHeaders();
            const response = await fetch(`/api/chat/rooms/${roomId}/messages`, { headers });
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const history = await response.json();
            history.forEach(message => showMessage(message));
        } catch (error) {
            console.error('Error fetching chat history:', error);
        }
    }

    function disconnect() {
        if (stompClient !== null) {
            stompClient.disconnect();
        }
        console.log("Disconnected");
        roomId = null;
        chatContainerDiv.style.display = 'none';
        roomManagementDiv.style.display = 'block';
    }

    function sendMessage() {
        const messageContent = messageInput.value;
        if (messageContent && stompClient) {
            const chatMessage = {
                roomId: roomId,
                sender: username, // Or get from token
                message: messageContent,
                type: 'TALK'
            };
            stompClient.send(`/app/chat.sendMessage`, {}, JSON.stringify(chatMessage));
            messageInput.value = '';
        }
    }

    function showMessage(message) {
        const messageElement = document.createElement('li');
        messageElement.textContent = `${message.senderName}: ${message.message}`;
        
        // Align message left or right
        if (message.senderName === username) {
            messageElement.className = 'message my-message';
        } else {
            messageElement.className = 'message other-message';
        }

        messagesDiv.appendChild(messageElement);
        messagesDiv.scrollTop = messagesDiv.scrollHeight; // Scroll to bottom
    }

    // Initial load
    window.onload = () => {
        // You can automatically fetch rooms if a token is present
        if(tokenInput.value) getRooms();
    };
    
    messageInput.addEventListener("keyup", function(event) {
        if (event.key === "Enter") {
            sendMessage();
        }
    });

</script>
</body>
</html>
